<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARãƒãƒ¼ã‚«ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
        }
        
        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
        }
        
        video {
            width: 100%;
            max-width: 640px;
            border: 2px solid #667eea;
            border-radius: 5px;
            display: block;
            margin: 20px auto;
        }
        
        canvas {
            display: none;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        #status.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        #status.success {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        #status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .marker-preview {
            text-align: center;
            margin: 20px 0;
        }
        
        .marker-preview img {
            max-width: 300px;
            border: 2px solid #667eea;
        }
        
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .download-section {
            margin-top: 30px;
            display: none;
        }
        
        .download-section.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“· ARãƒãƒ¼ã‚«ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
        
        <div class="instructions">
            <h3>æ‰‹é †</h3>
            <p><strong>æ–¹æ³•1: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</strong></p>
            <ol>
                <li>ã€Œç”»åƒã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã§ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                <li>ã€Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ç”Ÿæˆã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
            </ol>
            <p><strong>æ–¹æ³•2: ã‚«ãƒ¡ãƒ©ã§ã‚­ãƒ£ãƒ—ãƒãƒ£</strong></p>
            <ol>
                <li>ã€Œã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>å°åˆ·ã—ãŸãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã‚‹</li>
                <li>ã€Œãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã€ãƒœã‚¿ãƒ³ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</li>
            </ol>
        </div>
        
        <div id="status" class="info">ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‚’é¸æŠã™ã‚‹ã‹ã€ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„</div>
        
        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="text-align: center; margin: 20px 0; padding: 20px; background: #f0f4ff; border-radius: 10px;">
            <h3>ğŸ“ ç”»åƒã‹ã‚‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ</h3>
            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <button onclick="document.getElementById('image-upload').click()">ç”»åƒã‚’é¸æŠ</button>
            <div id="uploaded-preview" style="margin: 15px 0; display: none;">
                <img id="uploaded-image" style="max-width: 300px; border: 2px solid #667eea; border-radius: 5px;">
                <br><br>
                <button onclick="generateFromUpload()">ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ</button>
            </div>
        </div>
        
        <hr style="margin: 30px 0;">
        
        <h3 style="text-align: center;">ğŸ“· ã‚«ãƒ¡ãƒ©ã§ã‚­ãƒ£ãƒ—ãƒãƒ£</h3>
        
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div class="button-container">
            <button id="start-camera" onclick="startCamera()">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
            <button id="capture-marker" onclick="captureMarker()" disabled>ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£</button>
        </div>
        
        <div class="marker-preview">
            <h3>ç¾åœ¨ã®ãƒãƒ¼ã‚«ãƒ¼</h3>
            <img src="./assets/marker.png" alt="AR Marker" id="marker-image" onerror="this.style.display='none'">
            <p>ã“ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å°åˆ·ã—ã¦ã€ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
        </div>
        
        <div id="download-section" class="download-section">
            <h3>âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™å®Œäº†</h3>
            <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€<code>assets/pattern-marker.patt</code> ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="button-container">
                <button onclick="downloadPattern()">ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <details>
                <summary>ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆé«˜åº¦ãªä½¿ç”¨ï¼‰</summary>
                <pre id="pattern-data"></pre>
            </details>
        </div>
        
        <div class="instructions" style="margin-top: 30px;">
            <h3>ğŸ’¡ ç°¡å˜ãªæ–¹æ³•</h3>
            <p>ãƒãƒ¼ã‚«ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã€äº‹å‰ã«ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
            <div class="button-container">
                <button onclick="useDefaultPattern()">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨</button>
            </div>
        </div>
    </div>
    
    <script>
        let video, canvas, ctx;
        let patternData = null;
        let uploadedImage = null;
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('uploaded-image');
                img.src = e.target.result;
                document.getElementById('uploaded-preview').style.display = 'block';
                uploadedImage = new Image();
                uploadedImage.src = e.target.result;
                
                const status = document.getElementById('status');
                status.textContent = 'ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ã€Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
                status.className = 'info';
            };
            reader.readAsDataURL(file);
        }
        
        function generateFromUpload() {
            if (!uploadedImage) {
                alert('ç”»åƒã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const status = document.getElementById('status');
            status.textContent = 'ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆä¸­...';
            status.className = 'info';
            
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            // ç”»åƒã‚’æ­£æ–¹å½¢ã«ãƒˆãƒªãƒŸãƒ³ã‚°
            const size = Math.min(uploadedImage.width, uploadedImage.height);
            canvas.width = size;
            canvas.height = size;
            
            // ä¸­å¤®ã‹ã‚‰ã‚¯ãƒ­ãƒƒãƒ—
            const offsetX = (uploadedImage.width - size) / 2;
            const offsetY = (uploadedImage.height - size) / 2;
            
            ctx.drawImage(uploadedImage, offsetX, offsetY, size, size, 0, 0, size, size);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            generatePatternData();
            
            status.textContent = 'ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆå®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„';
            status.className = 'success';
            
            document.getElementById('download-section').classList.add('show');
        }
        
        function startCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            const status = document.getElementById('status');
            status.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’åˆæœŸåŒ–ä¸­...';
            status.className = 'info';
            
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' },
                audio: false 
            })
            .then(stream => {
                video.srcObject = stream;
                document.getElementById('start-camera').disabled = true;
                document.getElementById('capture-marker').disabled = false;
                status.textContent = 'ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„';
                status.className = 'info';
            })
            .catch(err => {
                console.error('Camera error:', err);
                status.textContent = 'ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ';
                status.className = 'error';
            });
        }
        
        function captureMarker() {
            const status = document.getElementById('status');
            status.textContent = 'ãƒãƒ¼ã‚«ãƒ¼ã‚’å‡¦ç†ä¸­...';
            status.className = 'info';
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºã«è¨­å®š
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ãƒ“ãƒ‡ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            ctx.drawImage(video, 0, 0);
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            generatePatternData();
            
            status.textContent = 'ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆå®Œäº†ï¼';
            status.className = 'success';
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('download-section').classList.add('show');
        }
        
        function generatePatternData() {
            // ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‹ã‚‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            // AR.jsäº’æ›ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // 16x16ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆï¼ˆAR.jsæ¨™æº–ï¼‰
            const patternSize = 16;
            const pattern = [];
            
            for (let i = 0; i < 3; i++) { // RGBãƒãƒ£ãƒ³ãƒãƒ«
                const channel = [];
                for (let y = 0; y < patternSize; y++) {
                    const row = [];
                    for (let x = 0; x < patternSize; x++) {
                        // ã“ã®ä½ç½®ã®ç”»åƒã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
                        const srcX = Math.floor(x * canvas.width / patternSize);
                        const srcY = Math.floor(y * canvas.height / patternSize);
                        const idx = (srcY * canvas.width + srcX) * 4;
                        
                        // è‰²ã®å€¤ã‚’å–å¾—ï¼ˆ0-255ï¼‰
                        const value = imageData.data[idx + i];
                        row.push(value);
                    }
                    channel.push(row);
                }
                pattern.push(channel);
            }
            
            // AR.jsãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
            patternData = formatPattern(pattern);
            document.getElementById('pattern-data').textContent = patternData;
        }
        
        function formatPattern(pattern) {
            let output = '';
            
            // AR.jsãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«: 4æ–¹å‘ã®å›è»¢ãŒå¿…è¦
            // 0åº¦ã€90åº¦ã€180åº¦ã€270åº¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            for (let rotation = 0; rotation < 4; rotation++) {
                for (let channel = 0; channel < 3; channel++) {
                    for (let y = 0; y < 16; y++) {
                        const row = [];
                        for (let x = 0; x < 16; x++) {
                            // å›è»¢ã«å¿œã˜ã¦åº§æ¨™ã‚’å¤‰æ›
                            let srcX, srcY;
                            switch(rotation) {
                                case 0: srcX = x; srcY = y; break;
                                case 1: srcX = 15 - y; srcY = x; break;
                                case 2: srcX = 15 - x; srcY = 15 - y; break;
                                case 3: srcX = y; srcY = 15 - x; break;
                            }
                            row.push(pattern[channel][srcY][srcX]);
                        }
                        output += row.join(' ') + '\n';
                    }
                }
                output += '\n';
            }
            
            return output.trim();
        }
        
        function downloadPattern() {
            if (!patternData) {
                useDefaultPattern();
                return;
            }
            
            const blob = new Blob([patternData], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'pattern-marker.patt';
            link.click();
        }
        
        function useDefaultPattern() {
            // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            const defaultPattern = generateDefaultPattern();
            patternData = defaultPattern;
            document.getElementById('pattern-data').textContent = defaultPattern;
            document.getElementById('download-section').classList.add('show');
            
            const status = document.getElementById('status');
            status.textContent = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™';
            status.className = 'success';
            
            // è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([defaultPattern], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'pattern-marker.patt';
            link.click();
        }
        
        function generateDefaultPattern() {
            // ãƒãƒ¼ã‚«ãƒ¼ç”¨ã®ç‰¹å¾´çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            let output = '';
            
            for (let channel = 0; channel < 3; channel++) {
                for (let y = 0; y < 16; y++) {
                    const row = [];
                    for (let x = 0; x < 16; x++) {
                        // ä¸­å¤®ã®æ­£æ–¹å½¢ã¨ã‚³ãƒ¼ãƒŠãƒ¼ã‚’æŒã¤ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆ
                        let value = 255; // ç™½
                        
                        // æ ç·š
                        if (x === 0 || x === 15 || y === 0 || y === 15) {
                            value = 0; // é»’
                        }
                        // ä¸­å¤®ã®æ­£æ–¹å½¢
                        else if (x >= 6 && x <= 9 && y >= 6 && y <= 9) {
                            value = 0; // é»’
                        }
                        // ã‚³ãƒ¼ãƒŠãƒ¼ãƒãƒ¼ã‚«ãƒ¼
                        else if ((x <= 3 && y <= 3) || (x >= 12 && y <= 3)) {
                            value = 0; // é»’
                        }
                        // è¿½åŠ ãƒ‘ã‚¿ãƒ¼ãƒ³
                        else if ((x === 4 && y === 7) || (x === 11 && y === 7)) {
                            value = 0; // é»’
                        }
                        
                        row.push(value);
                    }
                    output += row.join(' ') + '\n';
                }
                if (channel < 2) output += '\n';
            }
            
            return output;
        }
    </script>
</body>
</html>
